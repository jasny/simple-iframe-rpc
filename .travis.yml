language: node_js
node_js: 20
dist: jammy

branches:
  only:
    - main
    - /^v\d+\.\d+\.\d+$/

stages:
  - name: test
    if: tag IS blank
  - name: deploy

before_install:
  - git config --local user.name "LTO Network"
  - git config --local user.email "info@ltonetwork.com"
install:
  - npm install

jobs:
  fast_finish: true
  include:
    - name: "Test"
      stage: test
      script:
        - npm test
    - name: "Publish GitHub release"
      stage: deploy
      if: branch = main AND type = push
      before_script:
        - CURRENT_VERSION=$(git describe --tags --abbrev=0)
        - |
          if (git log $CURRENT_VERSION..HEAD | grep -q -i "\[bump:major\]"); then
            NEXT_VERSION=$(awk -F. -v OFS=. '{$1++;$2=0;$3=0;print}' <<< "$CURRENT_VERSION")
          elif (git log $CURRENT_VERSION..HEAD | grep -q -i "\[bump:minor\]"); then
            NEXT_VERSION=$(awk -F. -v OFS=. '{$2++;$3=0;print}' <<< "$CURRENT_VERSION")
          else
            NEXT_VERSION=$(awk -F. -v OFS=. '{$3++;print}' <<< "$CURRENT_VERSION")
          fi
      script:
        - git tag "$NEXT_VERSION"
      before_deploy:
        - npm run build
      deploy:
        provider: releases
        api_key:
          secure: "j2HEaDBvryma/ohGaNNI7EVRQt6tLNlYZwa3bNmWnCFmDL6AFm5Nxru2OP3wxU0CrYHR/nExP1kQdFFDtBObdy7Levz443+sGN3TNiV76XJfOVDcGmhQpqcPQ4+/hYM6nPvR0s8HB3y8eJd65U/kJ4dLmPIvLDfJ67zX9By2LN++7kFHbcs3A/DipDwwyG3Zyc7gYSqvDNxZ2/j8Ycs2RwkwU9XMX84Bum3EdNiPHJ+R2oLmhJlUq8wVOtPbBbl3gFGIaY6b9+ScX/1maCTjbVmFYnBv0zex37G7HTI6T306UdkOFNWqI5uOZRWPTqdX7d3L9V5cIR8Sz4JYFhHBWszZTViB2aN0fZGJMZcp3HQWgdzo95TtAd0qIJM9jCGpudhlyR+bPXAfoJyrhncdQeaIMMmzwFn7Wr2i/7WYXxdS4DllCH7QvrooH2bfT3eon3jnsohZlNp2pMrFHz4kGWeq7EJUqEnhrfrWlb6g6i/huPL3fjm+qe7MoIu0aZRMcCNUmusD7ED4G9bvGT5BC87nckpSn9xUJJSCNjjXHsBFqB1470GYwEO0mhFp7Nr4vEn8FtyZbt/BdrmNk9rtYnIpgNxh2CjMkQ37Fty4fAvwJ1oq/pJZJHuSLE3ocBXWERldbiFL0byFjSIUpwOXzyjh9x6oVDQH+YzZ+tjU6/o="
        cleanup: false
        skip_cleanup: true
        on:
          all_branches: true
        file_glob: true
        file: dist/*
    - name: "Publish to NPM"
      stage: deploy
      if: tag IS present
      before_install:
        - npm version $TRAVIS_TAG --no-git-tag-version
      script:
        - npx tsc
      deploy:
        provider: npm
        email: arnold@jasny.net
        api_key:
          secure: "hsyCQX4dpvVbavdaoa3uJeMuS1C2dDAq9NTFQ6R9ZzM1adVLdcBbWbHbDcdBGeRbkB5wyRKUcVKNYMD2XPF6KaZjr5rVavQ+aVeaoGDMGyVqeg4BPQVvlptRDHgrYMKEhpNa4ePprUMy+OdE4dOF/YUkY+aSPe7/5HpsGCOax/8V3fQ0dzh093q7p95gT3iUT+BvdJiWgoq8sz250kslwPo4pRhUvxjNjl9hFVM2Jf/81ujbw6JIdFz/U7uh+LuNQwu3lkwA1cfAXdzdh3HDr38ELwsUj/1SFig9AyfKMBx9w4Bc2rp+KtvVsBvFEKVsfTsCYZtzPc04yjtOzb2ne4JFxb32tPGQrwfId8hE7QhPThXySDboeZ776zJ2SAoJ0CHniEha2+W8569KlI5QZDa6d1g1ymmdFmeJm4ZCNT0kBILZ50lhEDXciXHClBKIqMrWxh2Txcma8ntzOEUcTtab9WR9xZ+Cla1aOMawOz/3Iu81HLnx+SG9ENiPg+E4QuAO/Rfnwo9eeKqWQ6TgpsOWufNx9mFDuOyLWzKlw22GO7+sYGbL/JmYS2Z0ab6ToWukxNyMMUK7oJHJdyTJ0zoatavUoqLoUeDt7ejc1PhTL69HOc/TwmBC99Hk2L0zlCzpWpir1eu54kG1bsFGCye2AsPY7Mcz0Dxilk+y378="
        on:
          tags: true
        cleanup: false
        skip_cleanup: true
